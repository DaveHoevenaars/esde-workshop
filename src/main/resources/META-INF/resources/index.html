<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    >
    <meta
      http-equiv="X-UA-Compatible"
      content="ie=edge"
    >

    <title>ESDE - Quarkus Base</title>

    <style type="text/css">
        img {
            width: 200px;
        }
    </style>
  </head>
  <body>
    <div>
      <h2>Submit new image</h2>
      <div>
        <p>
          <label for="image-url">Image URL:</label>
          <input
            type="text"
            id="image-url"
          />
        </p>
      </div>
      <div>
        <p>
          <label for="uploader">Uploader:</label>
          <input
            type="text"
            id="uploader"
          />
        </p>
      </div>
      <div>
        <p>
          <label for="comment">Comment:</label>
          <input
            type="text"
            id="comment"
          />
        </p>
      </div>
      <div>
        <p><span id="token"></span></p>
      </div>
      <div>
        <button id="submit">Submit</button>
      </div>
    </div>
    <hr>
    <div>
      <h2>Delete submission</h2>
      <div>
        <p>
          <label for="delete-id">ID:</label>
          <input type="text" id="delete-id" />
        </p>
      </div>
      <div>
        <p>
          <label for="delete-token">Token:</label>
          <input type="text" id="delete-token" />
        </p>
      </div>
      <div>
        <button id="delete">Submit</button>
      </div>
    </div>
    <hr>
    <button id="fetch-submissions">Fetch Submissions</button>


    <ul id="image-list"></ul>
    <script
      type="application/javascript"
      crossorigin="anonymous"
    >
      (() => {
        const endpoint = 'http://127.0.0.1:8080';

        /**
         *
         * @param endpoint
         * @param {HTMLElement} submissionsList
         * @return {Promise<void>}
         */
        async function loadSubmissions(endpoint, submissionsList) {
          const response            = await fetch(endpoint);
          const submissions         = await response.json();
          submissionsList.innerHTML = '';
          console.log(submissions);
          for (const s of submissions) {
            const imageDiv = document.createElement('div');
            const infoDiv  = document.createElement('div');
            {
              const image = document.createElement('img');
              image.src   = s.imageUrl;
              imageDiv.appendChild(image);
            }
            {
              const idSpan           = document.createElement('span');
              const uploaderSpan     = document.createElement('span');
              const imageUrlLink     = document.createElement('a');
              idSpan.innerText       = `ID: ${s.submissionId}`;
              uploaderSpan.innerText = `Uploader: ${s.uploader}`;
              imageUrlLink.href      = s.imageUrl;
              imageUrlLink.innerText = 'Source';
              imageUrlLink.target    = '_blank';

              infoDiv.appendChild(idSpan);
              infoDiv.appendChild(uploaderSpan);
              infoDiv.appendChild(imageUrlLink);
            }

            const listItem = document.createElement('li');
            listItem.appendChild(imageDiv);
            listItem.appendChild(infoDiv);
            submissionsList.appendChild(listItem);
          }
        }

        const imageListElement       = document.querySelector('#image-list');
        const imageUrlElement        = document.querySelector('#image-url');
        const uploaderElement        = document.querySelector('#uploader');
        const commentElement         = document.querySelector('#comment');
        const deleteIdElement         = document.querySelector('#delete-id');
        const deleteTokenElement         = document.querySelector('#delete-token');
        const tokenElement           = document.querySelector('#token');
        const submitButton           = document.querySelector('#submit');
        const deleteButton           = document.querySelector('#delete');
        const fetchSubmissionsButton = document.querySelector('#fetch-submissions');

        submitButton.addEventListener('click', async () => {
          console.log('clicked');
          const imageUrl         = imageUrlElement.value;
          const uploader         = uploaderElement.value;
          const comment          = commentElement.value;
          const response         = await fetch(endpoint + '/submissions', {
            body:   {imageUrl, comment, uploader, id: 0},
            method: 'POST',
          });
          const {token}          = await response.json();
          tokenElement.innerText = token;
          fetchSubmissionsButton.click();
        });

        fetchSubmissionsButton.addEventListener(
          'click',
          loadSubmissions.bind(null, endpoint + '/submissions', imageListElement),
        );

        deleteButton.addEventListener('click', async () => {
          const id = deleteIdElement.value;
          const token = deleteTokenElement.value;
          const response = await fetch(endpoint + '/submissions/' + id, {
            body: { token },
            method: 'DELETE'
          });
          fetchSubmissionsButton.click();
        });

        fetchSubmissionsButton.click();
      })();
    </script>
  </body>
</html>
